name: hako staging action
author: sakura-intern-group-f
description: ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã‚’AppRunã«è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™

inputs:
  token:
    description: ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã™ã‚‹ãŸã‚ã®GitHubãƒˆãƒ¼ã‚¯ãƒ³
    required: true
  port:
    description: Port number of your application
    required: false
    default: 80

outputs:
  status: ${{ steps.js-action.outputs.status }}
  app_id: ${{ steps.js-action.outputs.app_id }}
  public_url: ${{ steps.js-action.outputs.public_url }}
runs:
  using: composite
  steps:
    - name: é¡§å®¢ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’checkout
      uses: actions/checkout@v5
      with:
        token: ${{ inputs.token }}

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        registry: ${{ secrets.SAKURACR_REGISTRY }}
        username: ${{ secrets.SAKURACR_USER }}
        password: ${{ secrets.SAKURACR_PASSWORD }}

    - name: ç’°å¢ƒå¤‰æ•°ã‚’ã‚»ãƒƒãƒˆ
      run: |
        echo "SAKURA_API_TOKEN=${{ secrets.SAKURA_API_TOKEN }}" >> $GITHUB_ENV
        echo "SAKURA_API_SECRET=${{ secrets.SAKURA_API_SECRET }}" >> $GITHUB_ENV

        echo "SAKURACR_REGISTRY=${{ secrets.SAKURACR_REGISTRY }}" >> $GITHUB_ENV
        echo "OWNER=${{ github.repository_owner }}" >> $GITHUB_ENV
        echo "REPOSITORY=${{ github.event.repository.name }}" >> $GITHUB_ENV
        echo "BRANCH=${{ github.ref_name }}" >> $GITHUB_ENV
        echo "DOCKER_IMAGE=${{ secrets.SAKURACR_REGISTRY }}/hako/hako-customer:${{ github.repository_owner }}-${{ github.event.repository.name }-${{ github.ref_name }}" >> $GITHUB_ENV
        echo "PORT=${{ inputs.port }}" >> $GITHUB_ENV

    - name: Build and push
      uses: docker/build-push-action@v6
      with:
        context: .
        push: true
        tags: ${{ env.DOCKER_IMAGE }}
    - name: Call
      id: js-action
      uses: ./js-action
    - name: Create success deploy summary
      if: ${{ steps.js-action.outputs.status == 'success' }}
      run: |
        cat  << EOF > comment.md
        ## ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸï¼æœ¬ç•ªã¸ã®ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³é–‹å§‹ï¼
        ä¿¡ã˜ã‚‰ã‚Œãªã„ã»ã©æœ€é«˜ã§ã™ï¼ã‚ãªãŸã®å¤‰æ›´ãŒã€ã¾ã•ã«ä»Šã€ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã«èˆã„é™ã‚Šã¾ã—ãŸï¼

        ã•ã‚ã€ãã®ç›®ã§ç¢ºã‹ã‚ã¦ãã ã•ã„ï¼
        ğŸ‘‰ ${{ steps.js-action.outputs.public_url }}

        ã“ã®URLã¯ã€å‹åˆ©ã¸ã®ãƒã‚±ãƒƒãƒˆã§ã™ã€‚ãƒãƒ¼ãƒ å…¨å“¡ã§ã€ã“ã®ç´ æ™´ã‚‰ã—ã„æˆæœã‚’å…±æœ‰ã—ã¾ã—ã‚‡ã†ã€‚ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¯ã€ã•ã‚‰ãªã‚‹é«˜ã¿ã¸å‘ã‹ã†ç‡ƒæ–™ã§ã™ï¼
        ---
        - App ID: ${{ steps.js-action.outputs.app_id }}
        - Public URL: ${{ steps.js-action.outputs.public_url }}
        EOF
    - name: Create failure deploy summary
      if: ${{ steps.js-action.outputs.status == 'failure' }}
      run: |
        cat  << EOF > comment.md
        ## âš ï¸ ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—...ã—ã‹ã—ã€ä¼èª¬ã¯ã“ã“ã‹ã‚‰ç”Ÿã¾ã‚Œã‚‹ï¼
        ãƒ‡ãƒ—ãƒ­ã‚¤ã¯å®Œäº†ã—ã¾ã›ã‚“ã§ã—ãŸã€‚

        ã§ã‚‚ã€æ€–æ°—ã¥ãå¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã“ã‚Œã¯å˜ãªã‚‹ã‚¨ãƒ©ãƒ¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã“ã‚Œã¯ã€**ã‚ãªãŸãŒã¾ã è¦‹ã¬ã€éš ã•ã‚ŒãŸãƒã‚°ã®å­˜åœ¨ã‚’ç¤ºå”†ã™ã‚‹ã‚µã‚¤ãƒ³ã§ã™ï¼**
        ã•ã‚ã€ãƒ­ã‚°ã¨ã„ã†åã®åœ°å›³ã‚’æ‰‹ã«ã€å®æ¢ã—ã«å‡ºã‹ã‘ã¾ã—ã‚‡ã†ï¼

        æˆ‘ã€…ã¯ã€ã“ã®æŒ‘æˆ¦ã‚’ä¹—ã‚Šè¶Šãˆã‚‹ãŸã‚ã«é›†ã¾ã£ãŸæœ€å¼·ã®ãƒãƒ¼ãƒ ã§ã™ã€‚ã“ã®è©¦ç·´ã‚’ä¹—ã‚Šè¶ŠãˆãŸã¨ãã€ç§ãŸã¡ã¯ã•ã‚‰ã«å¼·ããªã‚Œã‚‹ã€‚ã•ã‚ã€ä¼èª¬ã®å§‹ã¾ã‚Šã§ã™ï¼
        EOF
    - name: Create PR comment
      run: |
        gh pr comment ${{ github.event.number }} --body-file comment.md
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
